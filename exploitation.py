import requests

# Replace with your actual base URL
base_url = "http://localhost:8000"  # Replace with the URL of your FastAPI app
line_length = 40  # Adjust the line length if needed

# Register a new user
register_response = requests.post(f"{base_url}/register", json={
    "name": "Test User",
    "login": "testuser",
    "password": "testpass"
})

if register_response.status_code == 201:
    print("User registered successfully.")
else:
    print(f"Failed to register user. Status code: {register_response.status_code}")
    print(f"Error details: {register_response.text}")
    exit()

# Login to get the access token
token_response = requests.post(f"{base_url}/token", data={
    "username": "testuser",
    "password": "testpass"
})

if token_response.status_code == 200:
    access_token = token_response.json().get("access_token")
    headers = {"Authorization": f"Bearer {access_token}"}
    print("Token obtained successfully.")
else:
    print(f"Failed to obtain token. Status code: {token_response.status_code}")
    print(f"Error details: {token_response.text}")
    exit()

# Data for creating a new receipt
receipt_data = {
    "products": [
        {"name": "Mavic 3T", "price": 870.0, "quantity": 3},
        {"name": "Дрон FPV з акумулятором 6S чорний", "price": 31000.0, "quantity": 20}
    ],
    "payment": {"type": "cash", "amount": 1516100.0}
}

# Step 1: Create a new receipt
create_response = requests.post(f"{base_url}/receipts", json=receipt_data, headers=headers)

if create_response.status_code == 201:
    # Extract the ID of the created receipt
    receipt_id = create_response.json().get("id")
    print(f"Receipt created successfully with ID: {receipt_id}")
    
    # Step 2: Retrieve the created receipt
    retrieve_response = requests.get(f"{base_url}/public/receipts/{receipt_id}", params={"line_length": line_length})
    
    if retrieve_response.status_code == 200:
        # Print the receipt text
        data = retrieve_response.json()
        print("Receipt:")
        print(data["receipt"])
    else:
        # Print the error message if the request failed
        print(f"Failed to retrieve receipt. Status code: {retrieve_response.status_code}")
        print(f"Error details: {retrieve_response.text}")
else:
    # Print the error message if the receipt creation failed
    print(f"Failed to create receipt. Status code: {create_response.status_code}")
    print(f"Error details: {create_response.text}")

"""
User registered successfully.
Token obtained successfully.
Receipt created successfully with ID: 1
Receipt:
ФОП Джонсонюк Борис
==============================
3.0 x Mavic 3T   2610.00
20.0 x Дрон FPV з 620000.00
------------------------------
СУМА    622610.00
Cash    1516100.00
Решта   893490.00
==============================
03.09.2024 22:50
Дякуємо за покупку!
"""